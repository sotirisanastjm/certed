// Prisma schema for Certed - Sitecore Certification Study Hub
// This schema supports certifications, study materials, quizzes, and user progress tracking

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================================================
// CERTIFICATION DOMAIN
// ============================================================================

model CertificationCategory {
    id             String          @id @default(cuid())
    slug           String          @unique
    name           String
    icon           String?
    description    String?
    sortOrder      Int             @default(0)
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    certifications Certification[]

    @@map("certification_categories")
}

model Certification {
    id               String                  @id @default(cuid())
    slug             String                  @unique
    name             String
    shortName        String?
    description      String?
    examFormat       String?
    passingScore     String?
    examType         String?
    examDuration     Int?
    questionCount    Int?
    supportAccess    Boolean                 @default(false)
    isActive         Boolean                 @default(true)
    sortOrder        Int                     @default(0)
    categoryId       String
    category         CertificationCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    createdAt        DateTime                @default(now())
    updatedAt        DateTime                @updatedAt
    competencies     Competency[]
    learningModules  LearningModule[]
    studyMaterials   StudyMaterial[]
    quizzes          Quiz[]
    userProgress     UserCertProgress[]
    documentationLinks DocumentationLink[]

    @@index([categoryId])
    @@map("certifications")
}

model Competency {
    id              String          @id @default(cuid())
    slug            String
    name            String
    description     String?
    weightPercent   Float?
    questionCount   Int?
    sortOrder       Int             @default(0)
    certificationId String
    certification   Certification   @relation(fields: [certificationId], references: [id], onDelete: Cascade)
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    topics          Topic[]
    studyMaterials  StudyMaterial[]
    questions       Question[]

    @@unique([certificationId, slug])
    @@index([certificationId])
    @@map("competencies")
}

model Topic {
    id             String          @id @default(cuid())
    slug           String
    name           String
    description    String?
    sortOrder      Int             @default(0)
    competencyId   String
    competency     Competency      @relation(fields: [competencyId], references: [id], onDelete: Cascade)
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    studyMaterials StudyMaterial[]
    questions      Question[]

    @@unique([competencyId, slug])
    @@index([competencyId])
    @@map("topics")
}

// ============================================================================
// LEARNING CONTENT DOMAIN
// ============================================================================

model LearningModule {
    id              String        @id @default(cuid())
    slug            String
    title           String
    description     String?
    estimatedTime   Int?
    sortOrder       Int           @default(0)
    certificationId String
    certification   Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt
    lessons         Lesson[]
    userModuleProgress UserModuleProgress[]

    @@unique([certificationId, slug])
    @@index([certificationId])
    @@map("learning_modules")
}

model Lesson {
    id             String              @id @default(cuid())
    slug           String
    title          String
    content        String              @db.Text
    contentType    LessonContentType   @default(TEXT)
    estimatedTime  Int?
    sortOrder      Int                 @default(0)
    moduleId       String
    module         LearningModule      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
    createdAt      DateTime            @default(now())
    updatedAt      DateTime            @updatedAt
    userLessonProgress UserLessonProgress[]

    @@unique([moduleId, slug])
    @@index([moduleId])
    @@map("lessons")
}

enum LessonContentType {
    TEXT
    VIDEO
    INTERACTIVE
    CODE_EXAMPLE
}

model StudyMaterial {
    id             String            @id @default(cuid())
    title          String
    description    String?
    content        String?           @db.Text
    materialType   StudyMaterialType
    sourceUrl      String?
    sourceName     String?
    difficulty     DifficultyLevel   @default(INTERMEDIATE)
    estimatedTime  Int?
    isOfficial     Boolean           @default(false)
    isActive       Boolean           @default(true)
    certificationId String?
    certification  Certification?    @relation(fields: [certificationId], references: [id], onDelete: SetNull)
    competencyId   String?
    competency     Competency?       @relation(fields: [competencyId], references: [id], onDelete: SetNull)
    topicId        String?
    topic          Topic?            @relation(fields: [topicId], references: [id], onDelete: SetNull)
    createdAt      DateTime          @default(now())
    updatedAt      DateTime          @updatedAt
    tags           MaterialTag[]

    @@index([certificationId])
    @@index([competencyId])
    @@index([topicId])
    @@index([materialType])
    @@map("study_materials")
}

enum StudyMaterialType {
    ARTICLE
    DOCUMENTATION
    VIDEO
    TUTORIAL
    COURSE
    BLOG_POST
    GUIDE
    CHEAT_SHEET
    PRACTICE_EXAM
    BOOK
}

enum DifficultyLevel {
    BEGINNER
    INTERMEDIATE
    ADVANCED
    EXPERT
}

model DocumentationLink {
    id              String        @id @default(cuid())
    title           String
    url             String
    description     String?
    category        String?
    isOfficial      Boolean       @default(true)
    sortOrder       Int           @default(0)
    certificationId String
    certification   Certification @relation(fields: [certificationId], references: [id], onDelete: Cascade)
    createdAt       DateTime      @default(now())
    updatedAt       DateTime      @updatedAt

    @@index([certificationId])
    @@map("documentation_links")
}

model MaterialTag {
    id        String          @id @default(cuid())
    name      String          @unique
    materials StudyMaterial[]

    @@map("material_tags")
}

// ============================================================================
// QUIZ AND ASSESSMENT DOMAIN
// ============================================================================

model Quiz {
    id              String         @id @default(cuid())
    slug            String
    title           String
    description     String?
    quizType        QuizType       @default(PRACTICE)
    difficulty      DifficultyLevel @default(INTERMEDIATE)
    timeLimit       Int?
    passingScore    Int            @default(80)
    isActive        Boolean        @default(true)
    certificationId String
    certification   Certification  @relation(fields: [certificationId], references: [id], onDelete: Cascade)
    createdAt       DateTime       @default(now())
    updatedAt       DateTime       @updatedAt
    questions       QuizQuestion[]
    attempts        QuizAttempt[]

    @@unique([certificationId, slug])
    @@index([certificationId])
    @@map("quizzes")
}

enum QuizType {
    PRACTICE
    MOCK_EXAM
    COMPETENCY_CHECK
    QUICK_REVIEW
}

model Question {
    id              String           @id @default(cuid())
    questionText    String           @db.Text
    explanation     String?          @db.Text
    questionType    QuestionType     @default(SINGLE_CHOICE)
    difficulty      DifficultyLevel  @default(INTERMEDIATE)
    isActive        Boolean          @default(true)
    competencyId    String?
    competency      Competency?      @relation(fields: [competencyId], references: [id], onDelete: SetNull)
    topicId         String?
    topic           Topic?           @relation(fields: [topicId], references: [id], onDelete: SetNull)
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt
    answers         Answer[]
    quizQuestions   QuizQuestion[]
    attemptAnswers  AttemptAnswer[]

    @@index([competencyId])
    @@index([topicId])
    @@map("questions")
}

enum QuestionType {
    SINGLE_CHOICE
    MULTIPLE_CHOICE
    TRUE_FALSE
    FILL_BLANK
    CODE_COMPLETION
}

model Answer {
    id             String          @id @default(cuid())
    answerText     String          @db.Text
    isCorrect      Boolean         @default(false)
    sortOrder      Int             @default(0)
    questionId     String
    question       Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
    createdAt      DateTime        @default(now())
    attemptAnswers AttemptAnswer[]

    @@index([questionId])
    @@map("answers")
}

model QuizQuestion {
    id         String   @id @default(cuid())
    sortOrder  Int      @default(0)
    quizId     String
    quiz       Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
    questionId String
    question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

    @@unique([quizId, questionId])
    @@index([quizId])
    @@index([questionId])
    @@map("quiz_questions")
}

// ============================================================================
// USER AND PROGRESS DOMAIN
// ============================================================================

model User {
    id                 String               @id @default(cuid())
    email              String               @unique
    passwordHash       String?
    displayName        String?
    avatarUrl          String?
    role               UserRole             @default(LEARNER)
    isActive           Boolean              @default(true)
    emailVerified      Boolean              @default(false)
    lastLoginAt        DateTime?
    createdAt          DateTime             @default(now())
    updatedAt          DateTime             @updatedAt
    certProgress       UserCertProgress[]
    moduleProgress     UserModuleProgress[]
    lessonProgress     UserLessonProgress[]
    quizAttempts       QuizAttempt[]
    bookmarks          Bookmark[]
    notes              UserNote[]

    @@map("users")
}

enum UserRole {
    LEARNER
    CONTRIBUTOR
    ADMIN
}

model UserCertProgress {
    id              String           @id @default(cuid())
    status          ProgressStatus   @default(NOT_STARTED)
    overallProgress Float            @default(0)
    studyHours      Float            @default(0)
    startedAt       DateTime?
    completedAt     DateTime?
    userId          String
    user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
    certificationId String
    certification   Certification    @relation(fields: [certificationId], references: [id], onDelete: Cascade)
    createdAt       DateTime         @default(now())
    updatedAt       DateTime         @updatedAt

    @@unique([userId, certificationId])
    @@index([userId])
    @@index([certificationId])
    @@map("user_cert_progress")
}

enum ProgressStatus {
    NOT_STARTED
    IN_PROGRESS
    COMPLETED
    ON_HOLD
}

model UserModuleProgress {
    id          String         @id @default(cuid())
    status      ProgressStatus @default(NOT_STARTED)
    progress    Float          @default(0)
    startedAt   DateTime?
    completedAt DateTime?
    userId      String
    user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    moduleId    String
    module      LearningModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
    createdAt   DateTime       @default(now())
    updatedAt   DateTime       @updatedAt

    @@unique([userId, moduleId])
    @@index([userId])
    @@index([moduleId])
    @@map("user_module_progress")
}

model UserLessonProgress {
    id          String         @id @default(cuid())
    status      ProgressStatus @default(NOT_STARTED)
    completedAt DateTime?
    userId      String
    user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    lessonId    String
    lesson      Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
    createdAt   DateTime       @default(now())
    updatedAt   DateTime       @updatedAt

    @@unique([userId, lessonId])
    @@index([userId])
    @@index([lessonId])
    @@map("user_lesson_progress")
}

model QuizAttempt {
    id           String          @id @default(cuid())
    score        Float?
    passed       Boolean?
    timeTaken    Int?
    startedAt    DateTime        @default(now())
    completedAt  DateTime?
    userId       String
    user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    quizId       String
    quiz         Quiz            @relation(fields: [quizId], references: [id], onDelete: Cascade)
    answers      AttemptAnswer[]

    @@index([userId])
    @@index([quizId])
    @@map("quiz_attempts")
}

model AttemptAnswer {
    id           String      @id @default(cuid())
    isCorrect    Boolean?
    timeTaken    Int?
    attemptId    String
    attempt      QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
    questionId   String
    question     Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
    answerId     String?
    answer       Answer?     @relation(fields: [answerId], references: [id], onDelete: SetNull)
    textResponse String?
    createdAt    DateTime    @default(now())

    @@index([attemptId])
    @@index([questionId])
    @@map("attempt_answers")
}

model Bookmark {
    id             String   @id @default(cuid())
    resourceType   String
    resourceId     String
    note           String?
    userId         String
    user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt      DateTime @default(now())

    @@unique([userId, resourceType, resourceId])
    @@index([userId])
    @@map("bookmarks")
}

model UserNote {
    id           String   @id @default(cuid())
    title        String?
    content      String   @db.Text
    resourceType String?
    resourceId   String?
    userId       String
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@index([userId])
    @@index([resourceType, resourceId])
    @@map("user_notes")
}

// ============================================================================
// KNOWLEDGE BADGES DOMAIN
// ============================================================================

model KnowledgeBadge {
    id           String   @id @default(cuid())
    slug         String   @unique
    name         String
    category     String
    badgeType    String
    description  String?
    imageUrl     String?
    isActive     Boolean  @default(true)
    sortOrder    Int      @default(0)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt
    userBadges   UserBadge[]

    @@map("knowledge_badges")
}

model UserBadge {
    id        String         @id @default(cuid())
    earnedAt  DateTime       @default(now())
    userId    String
    badgeId   String
    badge     KnowledgeBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

    @@unique([userId, badgeId])
    @@index([userId])
    @@map("user_badges")
}

// ============================================================================
// CONTENT SOURCES (for tracking documentation and articles)
// ============================================================================

model ContentSource {
    id          String   @id @default(cuid())
    name        String
    baseUrl     String
    description String?
    isOfficial  Boolean  @default(false)
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    resources   ExternalResource[]

    @@map("content_sources")
}

model ExternalResource {
    id          String        @id @default(cuid())
    title       String
    url         String        @unique
    description String?
    category    String?
    tags        String[]
    isVerified  Boolean       @default(false)
    lastChecked DateTime?
    sourceId    String
    source      ContentSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
    createdAt   DateTime      @default(now())
    updatedAt   DateTime      @updatedAt

    @@index([sourceId])
    @@map("external_resources")
}
